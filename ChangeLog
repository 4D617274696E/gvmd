2009-04-16  Matthew Mundell <matt@mundell.ukfsn.org>

	Improve the task abstraction by moving parsing of the task ID into
	find_task.  Separate out task code specific to the task representation.

	* src/manage.c: Reorder code to separate out representation-specific
	parts.
	(task_comment): New function.
	(free_task): Free attack_state.
	(make_task): Init start_time and end_time.
	(find_task): Update to take the ID as a string.
	(set_task_parameter): Replace IDENTIFIER parameter with NAME.

	* src/manage.h: Reorder headers.
	(find_task): Adjust header.

	* src/omp.c: Update find_task callers.

2009-04-14  Matthew Mundell <matt@mundell.ukfsn.org>

	Improve the task abstraction by accessing all task fields via functions
	and storing the current report in a global variable instead of in the
	task.

	* src/manage.c (current_report): New variable.
	(task_id, task_name, task_description, set_task_description)
	(task_run_status, set_task_run_status, task_start_time)
	(set_task_start_time, task_end_time, set_task_end_time)
	(task_report_count, task_attack_state, set_task_attack_state)
	(task_debugs_size, inc_task_debugs_size, task_holes_size)
	(inc_task_holes_size, task_infos_size, inc_task_infos_size)
	(task_logs_size, inc_task_logs_size, task_notes_size)
	(inc_task_notes_size): New functions.
	(free_task, make_task, create_report_file): Use new current_report
	variable.

	* src/manage.h: Add new headers.
	(fs_task_t): Remove current_report.

	* src/otp.c, src/omp.c: Use new task access functions and new global
	current_report.

2009-04-14  Matthew Mundell <matt@mundell.ukfsn.org>

	Improve task abstraction by changing task_t to a pointer and adding a
	task iterator.

	* src/manage.h (fs_task_t): New name for task_t.
	(task_t): Change to pointer to fs_task_t.  Update all users.
	(task_iterator_t): New struct.
	(task_count, init_task_iterator, next_task): New headers.
	(tasks_size, tasks, num_tasks): Remove.

	* src/manage.c (task_count, init_task_iterator, next_task): New functions.
	Update all task_t users.

	* src/otp.c: Update all task_t users.

	* src/omp.c: Update all task_t users.
	(omp_xml_handle_end_element): Add tracing and comment to
	CLIENT_DELETE_TASK case.  In CLIENT_STATUS iterate with task iterator.

2009-04-09  Matthew Mundell <matt@mundell.ukfsn.org>

	Write OTP report messages directly to the report on disk, instead of
	buffering the messages in memory.

	* src/manage.h (task_t): Correct run_status type.  Add current_report.
	Remove message arrays.
	(make_task): Adjust annotation.
	(make_report_id): Include in exportlocal annotation.

	* src/manage.c (free_message): Remove.
	(free_task, make_task): Handle current report.  Remove message array
	handling.
	(create_report_file): New function.  Body from src/otp.c save_report.
	(start_task): Create report stream before starting

	* src/otp.c (free_message): Enable.  Take only one arg.
	(write_message): Take stream and type args directly.
	(write_timestamp): Take host arg.
	(save_report): Just close the report stream.
	(append_timestamp): New function.
	(append_debug_message, append_hole_message, append_info_message)
	(append_log_message, append_note_message): Write the message to the report
	stream.
	(process_otp_server_input): Free current_message after appending it.
	Append timestamps in time cases.  In SERVER_DEBUG_OID and SERVER_HOLE_OID
	also check that the current_server_task exists.  Move report saving from
	HOST_END to SCAN_END.

2009-04-09  Michael Wiegand <michael.wiegand@intevation.de>

	* src/tests/common.c: Added connect_to_manager_host_port, a modification
	of connect_to_manager which allows connections to arbitrary hosts and
	ports. Made connect_to_manager a wrapper around
	connect_to_manager_host_port using OPENVASMD_ADDRESS and OPENVASMD_PORT.

2009-04-08  Matthew Mundell <matt@mundell.ukfsn.org>

	Cleanup and annotate more, from Splint.

	* src/types.h: New file.

	* src/splint.h (g_malloc, g_malloc0, g_ptr_array_add, g_slist_append,
	g_hash_table_destroy): New headers.
	(dirent_pointer_pointer): Remove "out" annotation.

	* src/ompd.h: Turn off exportlocal around server_address.
	(to_client_start, to_client_end): Change to buffer_size_t.

	* src/ompd.c (from_buffer_size, from_client_start, from_client_end,
	from_server_start, from_server_end): Change to buffer_size_t.
	(read_from_server): Remove tracing.  Cast count for += and gnutls_perror.
	Add count assertion.
	(serve_omp): Use buffer_size_t format in tracefs.  Change lastfds and fds
	to uint8_t.  Make fds checks explicitly boolean.  Change initial_start
	to buffer_size_t.

	* src/otp.h: Turn off exportlocal around server.

	* src/otp.c (from_buffer_size): Change to buffer_size_t.
	(tcp_string, udp_string, other_string, empty_string): New variables.
	(port_protocol_name): Return refs to variables instead of strings.  Add
	shared annotation.
	(print_port): Update format specifier for type change.
	(current_message): Add only annotation.
	(make_message): Annotate.  Cast g_malloc return.
	(message_data_t): Annotate members temp.
	(append_debug_message, append_hole_message, append_info_message,
	append_log_message, append_note_message): Annotate message arg keep.
	(current_server_preference,	current_server_plugin_dependency_name,
	current_server_plugin_dependency_dependencies): Annotate only.
	(add_server_preference,
	append_to_current_server_plugin_dependency): Annotate args keep.
	(add_server_plugins_dependency): Annotate args keep.  Make assert
	explicitly boolean.
	(finish_current_server_plugin_dependency): Make assert explicitly
	boolean.
	(free_rule): Annotate rule arg.  Check rule before freeing.
	(add_server_rule): Change arg annotation to keep.
	(from_server_start, from_server_end): Change to buffer_size_t.
	(parse_server_preference_value, parse_server_preference_value): Make
	assert explicitly boolean. Cast char for memchr.
	(parse_server_plugin_dependency_dependency, parse_server_server): Make
	from_start and from_end	buffer_size_t.  Annotate dependent variables.
	Correct <|> checks.
	(sync_buffer): Use buffer_size_t format in tracef.
	(process_otp_server_input): Make from_start and from_end size_t.
	Annotate dependent variables.  Cast char for memchr.  Ensure pointer
	comparisons are explicitly boolean.  Use g_malloc0 instead of g_newa.

	* src/manage.h: Turn off exportlocal around report_path_task_name and
	report_task.
	(set_task_parameter): Add null annotation to arg.
	(port_t): Add unsigned to type of number.

	* src/manage.c (set_task_parameter): Fail if value is NULL.
	(start_task): Send ntp_opt_show_end "no".
	(grow_description): Remove tracing.
	(append_task_open_port): Check task->open_ports before use.  Cast away
	g_array_append_val return.

	* src/ovas-mngr-comm.c (end_session): Pass fcntl a long zero.  Handle
	gnutls_bye return.
	(to_server_buffer_space): Check end and start before use.  Cast return.
	(connect_to_server): Cast socklen_t for fprintf and size_t for
	gnutls_perror.  Use z modifier for size_t tracef.

	* src/omp.h (to_client_start, to_client_end): Change type to buffer_size_t.

	* src/omp.c (to_client_start, to_client_end): Change type to buffer_size_t.
	(current_client_task): Add dependent annotation.
	(xml_context): Initialise.
	(SEND_TO_CLIENT): Remove.
	(send_to_client, error_send_to_client): New functions.
	(SEND_TO_CLIENT_OR_FAIL): New macro.
	(omp_xml_handle_start_element, send_requirement, send_dependency,
	send_preference, send_rule, send_reports): Replace old SEND_TO_CLIENT macro
	with new functions.
	(omp_xml_handle_end_element): Use SEND_TO_CLIENT_OR_FAIL and new send
	functions instead of SEND_TO_CLIENT.  Always check current_task_task_id
	before use.  Change pointer comparisons to be explicitly boolean.
	(from_client_start, from_client_end): Change to buffer_size_t.
	(init_omp_data): Free xml_context before setting it.
	(process_omp_client_input): Check xml_context before use.

	* src/otpd.c (from_buffer_size, from_client_start, from_client_end,
	from_server_start, from_server_end): Change to buffer_size_t.
	(serve_otp): Use buffer_size_t format for tracef.  Make fds checks
	explicitly boolean.  Change initial_start to buffer_size_t.  Cast count
	for	gnutls_perror.

	* src/openvasmd.c (from_buffer_size, from_client_start, from_client_end,
	from_server_start, from_server_end): Change to buffer_size_t.
	(read_protocol): Pass fcntl a long zero.

2009-04-07  Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>

	* CMakeLists.txt, doc/CMakeLists.txt, doc/openvasmd.8.xml,
	src/CMakeLists.txt, src/file.c, src/file.h, src/logf.h,
	src/manage.c, src/manage.h, src/omp.c, src/omp.h, src/ompd.c,
	src/ompd.h, src/openvasmd.c, src/otp.c, src/otp.h, src/otpd.c,
	src/otpd.h, src/ovas-mngr-comm.c, src/ovas-mngr-comm.h, src/splint.h,
	src/string.c, src/string.h, src/task.h, src/tracef.h,
	src/tests/CMakeLists.txt, src/tests/common.c, src/tests/common.h,
	src/tests/make_report_id_0.c, src/tests/omp_abort_task_0.c,
	src/tests/omp_delete_report_0.c, src/tests/omp_delete_report_1.c,
	src/tests/omp_delete_task_0.c, src/tests/omp_delete_task_1.c,
	src/tests/omp_get_dependencies_0.c, src/tests/omp_get_dependencies_1.c,
	src/tests/omp_get_nvt_feed_all_0.c, src/tests/omp_get_nvt_feed_all_1.c,
	src/tests/omp_get_nvt_feed_checksum_0.c, src/tests/omp_get_nvt_feed_checksum_1.c,
	src/tests/omp_get_nvt_feed_details_0.c, src/tests/omp_get_nvt_feed_details_1.c,
	src/tests/omp_get_preferences_0.c, src/tests/omp_get_preferences_1.c,
	src/tests/omp_get_report_0.c, src/tests/omp_get_rules_0.c,
	src/tests/omp_get_rules_1.c, src/tests/omp_modify_report_0.c,
	src/tests/omp_modify_task_0.c, src/tests/omp_new_task_0.c,
	src/tests/omp_start_task_0.c, src/tests/omp_start_task_1.c,
	src/tests/omp_status_0.c, src/tests/omp_status_1.c,
	src/tests/omp_status_2.c, src/tests/omp_status_3.c,
	src/tests/omp_status_4.c, src/tests/omp_version_0.c,
	src/tests/report_path_task_name_0.c, src/tests/report_path_task_name_1.c,
	src/tests/report_path_task_name_2.c, src/tests/rmdir_recursively_0.c,
	src/tests/rmdir_recursively_1.c, src/tests/strip_space_0.c,
	src/tests/strip_space_1.c, src/tests/strip_space_2.c,
	src/tests/strip_space_3.c, packaging/debian/copyright:
	Transferred Copyright from Intevation to Greenbone Networks.

2009-04-01  Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>

	* packaging/debian/control: Lower dependecy for debhelper from 6 to 5.

	* packaging/debian/changelog: New. A initial stub.

	* packaging/debian/copyright: New.

	* packaging/debian/rules: New. Initial version, not fully functional yet.

2009-04-01  Michael Wiegand <michael.wiegand@intevation.de>

	* src/tests/CMakeLists.txt: Added missing GLIB_CFLAGS to target properties.

2009-03-31  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/common.c (env_authenticate): Remove RATS annotation.

2009-03-31  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/omp_delete_task_0.c: Test by checking status instead of
	counting tasks.

2009-03-31  Matthew Mundell <matt@mundell.ukfsn.org>

	Cleanup and annotate, from Splint.  Comment RATS annotations.

	* src/CMakeLists.txt (splint): Switch to +unixlib.

	* src/splint.h: Add page headings.
	(gerrorpointer): New type.
	(g_error_free, g_ptr_array_free, g_file_set_contents,
	g_build_filename): New headers.
	(g_base64_decode): Correct return type.
	(strncasecmp, symlink): Remove.
	(scandir): Annotate filter arg.  "allocate" instead of "define" *namelist.

	* src/ompd.c (serve_omp): Set fds to a char.

	* src/manage.h (task_t): Annotate open_ports.
	(delete_task): Change arg type to **.

	* src/omp.c (omp_xml_handle_end_element): Use new delete_task arg type
	in CLIENT_DELETE_TASK.

	* src/ovas-mngr-comm.c: Remove socklen_t typedef.
	(write_to_server_buffer): Cast size for gnutls_record_send.

	* src/openvasmd.c (main): Comment RATS annotations.

	* src/manage.c (make_report_id): Check id before freeing.
	(grow_tasks): Comment RATS annotation.
	(free_task): Complete "releases" annotation.  Check task->description
	before freeing.  Turn off "branchstate" around free_task.
	(only_dirent_pointer): New type.
	(load_tasks_free, save_task_error): New functions.
	(load_tasks): Check names after scandir.  Call a shared cleanup function
	instead	of jumping.  Free file_name at the end of each task iteration.
	(save_task): Call a shared cleanup function	instead	of jumping.  Check
	task->description before using it.
	(set_task_parameter): Annotate value arg.  Check parameter for tracef.
	Fail if parameter is NULL.  Check values before freeing them.  Always free
	value.
	(delete_reports): Initialise names.
	(delete_task): Take a pointer to the task pointer.  Set the task pointer
	NULL before successfully returning.
	(append_to_task_comment, append_to_task_identifier): Free task member
	before assigning.  strdup to a temp for Splint.
	(grow_description): Comment RATS annotation.  Change tracef specifier.
	(add_task_description_line): Compare return to integer.

2009-03-30  Matthew Mundell <matt@mundell.ukfsn.org>

	Cleanup and annotate, from Splint.

	* src/otp.c: Include unistd.h and splint.h.
	(set_message_description, set_message_oid,
	append_to_current_server_plugin_dependency): Annotate.  Describe freeing of args.
	(write_messages): Add whitespace.
	(save_report): Check make_report_id return.  Cast away rmdir and unlink
	returns in error cases.
	(maybe_free_server_preferences,
	maybe_free_server_plugins_dependencies,
	maybe_free_current_server_plugin_dependency): Remove.
	(make_server_preferences): Free preferences first.
	(add_server_preference, make_current_server_plugin_dependency): Annotate
	args.
	(make_server_plugin_dependencies): Free dependencies first.
	(free_rule): Annotate args.  Cast away g_ptr_array_free rule.
	(add_server_rule): Annotate args.
	(init_otp_data): Clear plugins_md5.
	(parse_server_plugin_dependency_dependency): Return gboolean instead of
	int.  Annotate args.  Cast char for memchr.
	(parse_server_server): Annotate args and vars.  Cast char for memchr.
	Remove call to make_server_plugins_dependencies.
	(process_otp_server_input): Annotate vars.  Initialise match.  Free
	server.plugins_md5 before setting.  Remove call to
	maybe_free_server_preferences.

	* src/otpd.c (from_buffer_size): Change int to size_t.
	(serve_otp): Change fds to a short.

	* src/openvasmd.c (from_buffer_size, from_client_start, from_server_start,
	from_server_end): Change types to size_t.

2009-03-30  Matthew Mundell <matt@mundell.ukfsn.org>

	Cleanup and annotate, from Splint.

	* src/omp.h: Include sys/types.h.
	(to_client_start, to_client_end): Change type to size_t.

	* src/omp.c: Include splint.h.
	(to_client_start, to_client_end): Change type to size_t.
	(current_task_task_id, modify_task_parameter, modify_task_value,
	xml_context, send_requirement, send_preference,
	omp_xml_handle_error): Annotate.
	(send_dependency): Annotate.  Free msg.
	(SEND_TO_CLIENT): Cast TO_CLIENT_BUFFER_SIZE to size_t.
	(omp_xml_handle_start_element): Annotate arguments.  Check save_task
	return.
	(send_reports): Change return to int.
	(omp_xml_handle_end_element): Annotate.  In CLIENT_GET_REPORT case
	check for credentials username and check g_file_get_contents return
	directly.  In CLIENT_STATUS cast send_reports return and free reponse.
	(omp_xml_handle_text): Annotate args.  Use append_text instead of
	append_string.
	(process_omp_client_input): Check g_markup_parse_context_parse return
	directly.  Check error before using.

	* src/ovas-mngr-comm.c: Change Splint socklen_t to typedef.  Include
	splint.h.
	(end_session): Return success if shutdown error is ENOTCONN.
	(write_string_to_server): Cast gnutls_record_send arg.

2009-03-30  Matthew Mundell <matt@mundell.ukfsn.org>

	Cleanup and annotate, from Splint.

	* src/ompd.h: (to_client_start, to_client_end): Change to size_t.

	* src/ompd.c: Define socket for Splint.
	(read_from_client, read_from_server): Mark alert_name dependent.
	(write_to_client): Cast count for tracef.
	(serve_omp): Note old functions.  Use a single ret variable.  Check the
	return from end_session.

	* src/string.h (string): New type.
	(append_text): New function.
	(append_string): Use string.
	(strip_space): Annotate.

	* src/string.c (append_text): New function.
	(append_string): Change chars to gchars.
	(free_string_var): Chage var type to string.

	* src/file.c (G_LOG_DOMAIN): New define.
	(g_propagate_error, g_set_error, g_dir_close): New annotated headers for
	Splint.
	(rmdir_recursively): Annotate g_return_val_if_fail call.  Check return
	from g_dir_open directly, and on failure check that temp_error is set.
	Remove duplicate cleanup calls.

2009-03-30  Matthew Mundell <matt@mundell.ukfsn.org>

	Cleanup and annotate, from Splint.

	* src/splint.h: New file.

	* src/manage.h (credentials_t): Null annotate username and password.
	(task_t): Change types to gsize.  Annotate description.
	(tasks, task_id_string, make_task, find_task, set_task_parameter,
	make_report_id, report_task): Annotate.
	(add_task_description_line): Change int to size_t.

	* src/manage.c: Include splint.h.
	(append_to_credentials_username, append_to_credentials_password): Use
	append_text.
	(make_report_id): Doc fail return.  Init uuid.  Check returns.
	(report_task): Check that username is set.  Free link_name afterwards.
	(delete_report): Check that username is set.  Check error before use.
	Free link_name is fail case.
	(set_report_parameter): Check that username is set.  Check return of
	g_file_set_contents directly.  Check error before use.
	(tasks): Annotate.
	(task_id_string): Use snprintf instead of sprintf.
	(print_tasks): Check index before use.
	(grow_tasks): Change return to boolean.  Turn off checks around realloc
	and return.  Change memset arg to int.  Correct tracef directive.
	(free_message): Annotate args.
	(free_task): Annotate args.  Cast for tracef.  Cast away g_ptr_array_free
	returns.
	(free_tasks): Check tasks first.
	(make_tasks): Free name and comment on failure.  Add safety check on
	tasks.  Cast for id.  Turn off checks around assignments.  Correct tracef
	directive.
	(load_tasks): Init names and comment.  Free names[index] for hidden files.
    Check g_file_get_contents return directly.  Check error before use.
	Remove freeing of name and comment on failure, as now done in make_task.
	(save_task): Check g_file_get_contents return directly.  Check error before
	use.  Use snprintf instead of sprintf.
	(save_tasks): Free dir_name.
	(find_task): Check tasks before using.  Compare to NULL explicitly.
	(set_task_parameter): Check parameter before use.
	(start_task): Cast away g_array_free return.  Cast size for g_array_new.
	(delete_reports): Anotate var.  Free names[index] for hidden files.
	(delete_task): Check return from rmdir_recursively directly.  Check error
	before use.
	(append_to_task_comment): Annotate arg.  Return integer explicitly.
	(append_to_task_identifier): Annotate arg.  Free task->name.  Return
	integer explicitly.  Correct return value.
	(grow_description): Change new_size to size_t.  Cast char for memset.
	(add_task_description_line): Use return from g_array_append_val.

2009-03-28  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/common.c (env_authenticate): Add "RATS: ignore" for getenv.

2009-03-28  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/CMakeLists.txt: Add omp_delete_report_1.

2009-03-28  Matthew Mundell <matt@mundell.ukfsn.org>

	Start implementing splint and RATS cleanups.

	* src/ovas-mngr-comm.h (end_session): Correct return type.
	(connect_to_server): Change argument "interrupted" to a gboolean.

	* src/ovas-mngr-comm.c: Define socklen_t for splint.  Include glib.
	Declare global vars static.  Move all local vars to beginnings of blocks.
	(make_session): Cast some returns to please splint.
	(send_to_server): Use memmove instead of memcpy, just to be sure.
	(connect_to_server): Change argument "interrupted" to a gboolean.  Cast
	the sizeof return to match the ret_len type.

	* src/otp.c: Define PREFIX.  Declare functions and vars static.  Move
	all local vars to beginnings of blocks.  Annotate most global vars as
	null.
	(process_otp_server_input): Add fallthrough to SERVER_INIT_SENT_VERSION
	case.

	* src/otpd.c: Move all local vars to beginnings of blocks.
	(serve_otp): Annotate reach.

2009-03-28  Matthew Mundell <matt@mundell.ukfsn.org>

	Start implementing splint and RATS cleanups.

	* src/manage.h (append_to_credentials_username): Change third arg to
	gsize.
	(current_server_task): Annotate as null.

	* src/manage.c: Define g_free with annotation for splint.  Include
	string and strings.  Define PREFIX.  Declare functions and vars static.
	Move all local vars to beginnings of blocks.  Annotate global vars as null.
	(append_to_credentials_username, append_to_credentials_password): Append
	with append_string.
	(report_path_task_name): Change type of path2_length to size_t.
	(print_tasks): Use standard ternary format.
	(grow_tasks): Add "RATS: ignore" to realloc.
	(grow_description): Add "RATS: ignore" to realloc.  Clear new memory.

	* src/file.c: Declare fchdir for splint.  Move all local variable
	declarations to beginnings of blocks.
	(rmdir_recursively): Cast variables to quiet splint.

	* src/string.h (append_string, free_string_var): Drop arg names.
	(strip_space): Annotate return as shared.

2009-03-28  Matthew Mundell <matt@mundell.ukfsn.org>

	Start implementing splint and RATS cleanups.

	* src/openvasmd.c: Conditionalise some includes for splint.  Correct
	the openvas includes.
	(cleanup): Move the OMP freeing note to src/ompd.c.
	(handle_signal): Remove.
	(handle_sigint, handle_sighup, handle_sigterm): New functions.
	(main): Separate signal handlers.

	* src/omp.c: Define PREFIX.  Declare functions and vars static.
	Annotate global null vars.  Move all local vars to beginnings of
	blocks.
	(send_reports): Correct freeing of msg and names.
	(omp_xml_handle_end_element): Add block for CLIENT_NEW_TASK case.  Free
	response in CLIENT_STATUS case.

	* src/ompd.c: Declare functions and vars static.  Move all local
	variable declarations to beginnings of blocks.  Add missing includes.
	(read_from_client, read_from_server, write_to_client): Cast variables
	to quiet splint.  Annotate dummy arguments.
	(write_to_server): Annotate fallthrough cases.
	(serve_omp): Add OMP freeing note from src/openvasmd.c.  Cast
	variables.

2009-03-28  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/logf.h: Include stdlib.
	(logf): Cast getpid return.  Check fflush return.

	* src/tracef.h: Include stdlib.
	(tracef): Cast getpid return.  Check fflush return.

2009-03-28  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/CMakeLists.txt (splint, rats, flawfinder, check, etags, ctags,
	tags): New targets.
	(ovas-mngr-comm): Add Glib C flags.

2009-03-26  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/omp_delete_task_1.c: Read report ID from response.

2009-03-26  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/omp.c (omp_xml_handle_end_element): Always respond to the client,
	in CLIENT_DELETE_REPORT.

	* src/tests/omp_delete_report_1.c: New test.  Tests DELETE_REPORT with
	empty ID.

2009-03-24  Matthew Mundell <matt@mundell.ukfsn.org>

	Add more tests.

	* src/tests/make_report_id_0.c, src/tests/omp_delete_task_1.c,
	src/tests/omp_get_dependencies_0.c, src/tests/omp_get_dependencies_1.c,
	src/tests/omp_get_nvt_feed_all_0.c, src/tests/omp_get_nvt_feed_all_1.c,
	src/tests/omp_get_nvt_feed_checksum_0.c,
	src/tests/omp_get_nvt_feed_checksum_1.c,
	src/tests/omp_get_nvt_feed_details_0.c,
	src/tests/omp_get_nvt_feed_details_1.c,
	src/tests/omp_get_preferences_0.c, src/tests/omp_get_preferences_1.c,
	src/tests/omp_delete_report_0.c, src/tests/omp_get_report_0.c,
	src/tests/omp_get_rules_0.c, src/tests/omp_get_rules_1.c,
	src/tests/omp_modify_report_0.c, src/tests/omp_start_task_1.c,
	src/tests/omp_status_1.c, src/tests/omp_status_2.c,
	src/tests/omp_status_3.c, src/tests/omp_status_4.c,
	src/tests/report_path_task_name_0.c, src/tests/report_path_task_name_1.c,
	src/tests/report_path_task_name_2.c: New tests.

	* src/tests/CMakeLists.txt: Add rules for new tests.

2009-03-21  Matthew Mundell <matt@mundell.ukfsn.org>

	Switch to universal report identifiers.

	* src/manage.h (make_report_id, report_path_task_name, report_task): New
	headers.

	* src/manage.c (make_report_id, report_path_task_name, report_task): New
	functions.
	(delete_report, set_report_parameter): Switch to UUIDs.

	* src/omp.c (send_reports): Switch to UUIDs.  Free all names on	send fail.
	(omp_xml_handle_end_element): Switch to UUIDs for reports.  Correct
	response tag in CLIENT_GET_REPORT.

	* src/otp.c (save_report): Switch to UUIDs.

	* src/CMakeLists.txt: Add -lossp-uuid to openvasmd.

2009-03-20  Matthew Mundell <matt@mundell.ukfsn.org>

	Add a task status enumeration.  Rename task_t running slot to run_status.

	* src/manage.h (task_status_t): New type.
	(task_t): Rename running to run_state.

	* src/manage.c (make_task, start_task, stop_task): Use new task status
	enum.

	* src/omp.c (omp_xml_handle_end_element): Use new task status enum.

	* src/otp.c (process_otp_server_input): Use new task status enum.

2009-03-20  Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>

	* packaging/: New.

	* packaging/debian: New.

	* packaging/debian/control: New. First approaches for
	Debian packaging.

2009-03-19  Matthew Mundell <matt@mundell.ukfsn.org>

	Add per-report directories.  Add initial OMP MODIFY_REPORT.

	* src/omp.c (client_state_t): Add MODIFY_REPORT states.
	(omp_xml_handle_start_element, omp_xml_handle_text): Add MODIFY_REPORT
	 handling.
	(omp_xml_handle_end_element): In CLIENT_GET_REPORT get the report from the
	report's directory.  Add MODIFY_REPORT handling.

	* src/otp.c (save_report): Save report to a dedicated directory.

	* src/manage.h (set_report_parameter): New header.

	* src/manage.c (set_report_parameter): New function.
	(delete_report): Account for per-report directory.

2009-03-19  Matthew Mundell <matt@mundell.ukfsn.org>

	Update OTP BYE handling for reconnecting to the server during an OMP
	session.

	* src/openvasmd.c (serve_client): Move session creation and freeing to
	src/ovas-mngr-comm.c.
	(serve_client): Pass server_socket pointer to serve_omp.

	* src/ovas-mngr-comm.c (make_session, end_session): New functions, from
	src/openvasmd.c.
	(connect_to_server): Improve message slightly.

	* src/ovas-mngr-comm.h (make_session, end_session): New headers.

	* src/ompd.c (serve_omp): Take a pointer to the server socket instead
	of the server socket.  On receiving server BYE recreate the server
	socket and session.

	* src/ompd.h (serve_omp): Add arguments.

	* src/otp.c (process_otp_server_input): Read over whitespace at start of
	SERVER_INIT_SENT_VERSION.  In SERVER_BYE add success case and correct the
	"need more input" return value.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/ompd.c (serve_omp): Revert bogus typo correction.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/omp.c (omp_xml_handle_end_element): Free name in CLIENT_GET_REPORT
	case.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/omp.c (send_reports): Use scandir's report_name directly, instead
	of wrapping it in a g_path_get_basename.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/manage.c (delete_report): Add @return doc.

	* ChangeLog: Fixup pathnames for today's entries.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	Reactivate BYE-initiated server socket shutdown.

	* src/otp.c (process_otp_server_input): Return a unique value on receiving
	BYE.

	* src/ompd.c (serve_omp): Shutdown server socket according to
	process_otp_server_input return.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/ompd.c (serve_omp): Correct typo and formatting.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/manage.c (stop_task, start_task): Correct conditions of running checks.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	Ensure that delete_task also removes the symlinks to the directory of
	all the user's reports.

	* src/manage.h (delete_report): Add const to arg.

	* src/manage.c (delete_report): Add const to arg.
	(delete_reports): New function.
	(delete_task): Call delete_reports to delete reports.

2009-03-13  Matthew Mundell <matt@mundell.ukfsn.org>

	Move report deleting into manage library.

	* src/manage.c (delete_report): New function.

	* src/manage.h (delete_report): New header.

	* src/omp.c (omp_xml_handle_end_element): Use new function delete_report.

2009-03-12  Matthew Mundell <matt@mundell.ukfsn.org>

	Add OMP DELETE_REPORT.

	* src/otm.c (client_state_t): Add DELETE_REPORT states.
	(omp_xml_handle_start_element, omp_xml_handle_end_element,
	omp_xml_handle_text): Add DELETE_REPORT handling.

2009-03-12  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/otp.c (save_report): Move the actual report into the task directory.

2009-03-11  Matthew Mundell <matt@mundell.ukfsn.org>

	Add per-user reports directories.

	* src/otp.c (save_report): Save the report to the report directory of the
	user and link the report to the task directory, instead of saving to the
	task directory.

	* src/omp.c (omp_xml_handle_end_element): Get the report from the user
	report directory instead of the task directory.  Ensure the report name
	has the right format.  Free content_error.  Free current_task_task_id in
	the fail case.

2009-03-11  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/omp.c (output_reports_xml): Rename to send_reports.
	(send_reports): Rename from output_reports_xml.  Add doc.

2009-03-11  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/omp.c (client_state_t): Add GET_REPORT states.
	(omp_xml_handle_start_element, omp_xml_handle_end_element,
	omp_xml_handle_text): Add GET_REPORT handling.

2009-03-10  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/common.c (wait_for_task_end): New function.

	* src/tests/common.h (wait_for_task_end): New header.

2009-03-10  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/omp.c (output_reports_xml): New function.
	(omp_xml_handle_end_element): Add reports to STATUS response
	in case where STATUS is given a task ID.

2009-03-10  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/otp.c (process_otp_server_input): Add "done" task state.

	* src/omp.c (omp_xml_handle_end_element): Add "done" task state.

2009-03-02  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/manage.c (delete_task): Correct error check.

2009-03-02  Matthew Mundell <matt@mundell.ukfsn.org>

	Add "Requested" task running state.  Correct STATUS_RESPONSE tags and
	CLIENT_MODIFY_TASK variable usage.

	* src/otp.c (process_otp_server_input): Update task running state
	on receiving SCAN_START.

	* src/omp.c (omp_xml_handle_end_element): Add printing of new running
	state.  Rename TASK_STATUS entity in TASK in STATUS_RESPONSE to STATUS.
	Correct STATUS_RESPONSE closing tags.  In CLIENT_MODIFY_TASK case
	use local var instead of setting current_client_task.

	* src/manage.h (task_t): Note new running state.

2009-03-02  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/common.c: Turn off some tracing.
	(DO_CHILDREN, id_string, wait_for_task_start, delete_task): New functions.

	* src/tests/common.h (delete_task, wait_for_task_start): New headers.

	* src/tests/omp_abort_task_0.c, src/tests/omp_start_task_0.c,
	src/tests/omp_modify_task_0.c, src/tests/omp_modify_task_0.c: Wait for
	server with	wait_for_task_start.  Delete task on exit.

2009-03-01  Matthew Mundell <matt@mundell.ukfsn.org>

	Reduce number of gotos.

	* src/ompd.c (read_from_server): Retry with while instead of goto.

	* src/omp.c (send_dependency): Move SEND_TO_CLIENT destination to end
	of function.
	(omp_xml_handle_end_element): Neaten indentation.

	* src/openvasmd.c (read_protocol): Retry with while instead of goto.

	* src/otp.c (parse_server_done, parse_server_preference_value,
	parse_server_rule, parse_server_plugin_dependency_dependency,
	parse_server_server, sync_buffer): New functions.
	(process_otp_server_input): Call new parsing and sync functions instead
	of jumping.  Return immediately instead of jumping to fail code.  Use
	g_strdup instead of strdup.  Drop make_message return checks.

    * src/manage.c (load_tasks, save_task): Move fail destinations to ends
	of functions.

2009-02-28  Matthew Mundell <matt@mundell.ukfsn.org>

	Add env_authenticate and use it in tests.

	* src/tests/common.c: Reorder functions.
	(env_authenticate): New function.

	* src/tests/common.h: Reorder headers.
	(env_authenticate): New header.

	* src/tests/omp_new_task_0.c, src/tests/omp_version_0.c,
	src/tests/omp_delete_task_0.c, src/tests/omp_abort_task_0.c,
	src/tests/omp_start_task_0.c, src/tests/omp_modify_task_0.c,
	src/tests/omp_status_0.c: Use env_authenticate instead of authenticate.

2009-02-28  Matthew Mundell <matt@mundell.ukfsn.org>

	Start separating the implementation into components.

	* src/openvasmd.c: Move most functions and variables out to new files.
	Improve	implementation notes in @file.
	(free_g_ptr_array): Remove old function.
	(OMP): Remove old directive.
	(BUFFER_SIZE): Rename FROM_BUFFER_SIZE.
	(from_buffer_size): New variable.

	* src/logf.h, src/manage.c, src/manage.h, src/otp.c, src/otp.h, src/omp.c,
	src/omp.h, src/ompd.c, src/ompd.h, src/otpd.c, src/otpd.h: New files.

	* src/tracef.h (TRACE, TRACE_TEXT): New directive, previously in
	openvasmd.c.

	* src/file.c: Include unistd.h.

	* src/string.c (free_string_var, append_string): New functions, previously
	in openvasmd.c.

	* src/string.h (free_string_var, append_string): New headers.

	* src/ovas-mngr-comm.c (write_string_to_server, write_to_server_buffer):
	New functions, previously in openvasmd.c.
	(to_server_buffer_space): New function.
	(BUFFER_SIZE): Rename TO_SERVER_BUFFER_SIZE.

	* src/ovas-mngr-comm.h (write_string_to_server, write_to_server_buffer,
	to_server_buffer_space): New headers.

	* src/CMakeLists.txt: Build new libraries.

    * src/tests/CMakeLists.txt: Add GLIB path to strip_space LDFLAGS.

	* doc/CMakeLists.txt (.build-html): Add new files.

	* doc/Doxyfile (INPUT): Add new files.

2009-02-23  Matthew Mundell <matt@mundell.ukfsn.org>

	Update commands to clear current_task_task_id after use.

	* src/openvasmd.c (free_string_var, append_string): New functions.
	(omp_xml_handle_start_element): Leave clearing of current_task_task_id
	to omp_xml_handle_end_element.
	(omp_xml_handle_end_element): Free current_task_task_id after use.
	(omp_xml_handle_text): Append to string variables with append_string.
	(serve_omp): Note exit behaviour.

2009-02-23  Matthew Mundell <matt@mundell.ukfsn.org>

	Use shared functions for starting tasks.  Authenticate only once per
	session, for now.

	* src/tests/common.c (sendf_to_manager, start_task): New functions.

	* src/tests/common.h (sendf_to_manager, start_task): New headers.

	* src/tests/omp_abort_task_0.c: Use start_task.  Send actual task ID.
	Authenticate once per session.

	* src/tests/omp_delete_task_0.c: Improve task name.

	* src/tests/omp_start_task_0.c: Authenticate once.

	* src/tests/omp_modify_task_0.c: Improve task name.  Authenticate once.
	Send actual task ID.

	* src/tests/omp_status_0.c: Use start_task.  Authenticate once.

2009-02-22  Matthew Mundell <matt@mundell.ukfsn.org>

	Cleanup docs.  Neaten XML strings.  Rename XML_RESPOND to
	SEND_TO_CLIENT.  Update load_tasks to loop through dirs forwards
	instead of sorting dirs backwards.

	* src/openvasmd.c: Cleanup docs.  Neaten XML strings.
	(ahplasort): Remove.
	(load_tasks): Loop through dirs forwards instead of sorting backwards.
	(set_task_parameter): Add const to parameter argument.
	(XML_RESPOND): Remove, rename SEND_TO_CLIENT.
	(SEND_TO_CLIENT): New macro, previously XML_RESPOND.
	(omp_xml_handle_end_element): Move OMP_VERSION_RESPONSE attribute to
	entity.

	* src/ovas-mngr-comm.c: Correct doc typos.

	* src/tests/common.c: Cleanup docs.  Add @file doc.

	* src/tests/omp_version_0.c: Move expected attribute to entity.

	* doc/CMakeLists.txt: Run Doxygen in top-level dir to get relative paths.

	* doc/Doxyfile: Adjust paths for running in top-level dir.

2009-02-21  Matthew Mundell <matt@mundell.ukfsn.org>

	Add Base64 task file handling.  Add new library with function
	rmdir_recursively.  Add tests of rmdir_recursively.  Update DELETE_TASK
	to remove the task directory on	disk.  Update tests to use shared
	functions for creating tasks.

	* src/file.h, src/file.c, src/tests/new_task_empty_rc,
	src/tests/new_task_medium_rc, src/tests/new_task_small_rc,
	src/tests/rmdir_recursively_0.c, src/tests/rmdir_recursively_1.c: New
	files.

	* src/openvasmd.c: Include new file library.
	(free_task): Reduce tracing.
	(save_tasks): Add a comment.
	(modify_task): Remove, was for old OMP spec.
	(set_task_parameter): Clarify doc.  Add base64 task file handling.
	(delete_task): Update to remove task directory.
	(omp_xml_handle_end_element): Add base64 task file handling.
	(serve_client): Enable cipher and mac.

	* src/CMakeLists.txt: Add file library.

	* src/tests/CMakeLists.txt: Add tests rmdir_recursively_0 and
	rmdir_recursively_1.

	* src/tests/common.c (create_task_from_rc_file, create_task): New
	functions.
	(add_entity): Clarify doc.
	(compare_entities): Add NULL checks.  Correct typo.

	* src/tests/common.h (create_task_from_rc_file, create_task): New headers.

	* src/tests/omp_start_task_0.c, src/tests/omp_status_0.c: Use
	create_task_from_rc_file.  Read task description from file instead of var.

	* src/tests/omp_modify_task_0.c: Use create_task.

	* src/tests/omp_new_task_0.c: Neaten XML string.  Get and use actual task
	ID.

	* src/tests/omp_delete_task_0.c: Use create_task_from_rc_file.

2009-02-20  Matthew Mundell <matt@mundell.ukfsn.org>

	Add OMP AUTHENTICATE.  Remove handling of first OMP specification.

	* src/openvasmd.c (credentials, login, process_omp_old_client_input,
	RESPOND): Remove.
	(client_state_t): Add authentication states.
	(credentials_t): New type.
	(current_credentials): New variable.
	(append_to_credentials_password, append_to_credentials_username,
	authenticate, free_credentials): New functions.
	(tasks): Clarify doc.
	(load_tasks): Return if tasks already loaded.  Use username from
	current_credentials.  Free tasks on error.
	(save_tasks): Check if tasks are loaded.  Use username from
	current_credentials.
	(save_report): Use username from current_credentials.
	(omp_xml_handle_end_element, omp_xml_handle_start_element,
	omp_xml_handle_text): Add AUTHENTICATE handling.  Set error parameter on
	error.
	(omp_xml_handle_error): Remove abort call.
	(process_omp_client_input): Add some error trace messages.
	(serve_omp): Note behaviour on process_omp_client_input error.
	(serve_client): Neaten some formatting.
	(accept_and_maybe_fork): Remove task loading now done after	authentication.
	(cleanup): Adjust credential freeing.

	* src/tests/common.c (authenticate): New function.
	(compare_entity_with_name, entity_child, entity_name, entity_text): Add doc.
	(read_entity): Check context_data.first has been set before accessing
	member.

	* src/tests/common.h (authenticate): New function.

	* src/tests/omp_new_task_0.c, src/tests/omp_version_0.c,
	src/tests/omp_abort_task_0.c, src/tests/omp_delete_task_0.c,
	src/tests/omp_start_task_0.c, src/tests/omp_modify_task_0.c,
	src/tests/omp_status_0.c: Add authentication.

2009-02-19  Matthew Mundell <matt@mundell.ukfsn.org>

	Add saving of reports and tasks on disk.  Rename "reports" to
	"messages".  Move port code up to a dedicated page.  Check for alerts
	on TLS error.  Explicitly set all TLS priorities.

	* src/openvasmd.c (ahplasort, free_message, load_tasks, print_port,
	port_protocol_name, save_report, save_task, save_tasks, set_message_oid,
	task_id_string, write_message, write_messages, write_timestamp): New
	functions.
	(report_t): Rename message_t.
	(message_t): New type previously named report_t.
	(current_report): Rename current_message.
	(current_message): New var previously named current_report.
	(make_report, set_report_description, append_debug_report,
	append_hole_report, append_info_report, append_log_report,
	append_note_report): Rename with "message" instead of "report".
	(make_message, set_message_description, append_debug_message,
	append_hole_message, append_info_message, append_log_message,
	append_note_message): New functions previously named with "report".
	(message_data_t): New type.
	(task_t): Add report_count.
	(free_task): Free messages with free_message instead of free_rule.
	(make_task): Clarify return doc.  Init report count.
	(find_task): Correct while style.
	(set_task_parameter): Also set description_size when setting description.
	(append_to_task_comment, append_to_task_identifier, delete_task,
	grow_description, start_task, stop_task): Add direction to @params.
	(serve_otp, read_from_client, read_from_server, read_protocol): Check for
	alerts on TLS error.
	(omp_xml_handle_end_element): Output actual report count for STATUS.
	(process_omp_server_input): Set message OIDs with set_message_oid instead
	of set_message_description.  Save report to disk on receiving HOST_END.
	(serve_client): Explicitly set all TLS priorities instead of using
	gnutls_set_default_priority, in order to match the server's priorities.
	(accept_and_maybe_fork): Load tasks at start of child and save tasks at
	end of child.

	* Changelog: Replace some space offsets with tabs.

2009-02-09  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (client_state_t, omp_xml_handle_start_element,
	omp_xml_handle_end_element): Add dummy GET_NVT_FEED_ALL,
	GET_NVT_FEED_CHECKSUM and GET_NVT_FEED_DETAILS handling.

2009-02-06  Matthew Mundell <matt@mundell.ukfsn.org>

	Add OMP GET_DEPENDENCIES and GET_RULES.  Correct OTP rule parsing.

	* src/openvasmd.c (free_g_slist, send_dependency, send_preference,
	send_requirement, send_rule): New functions.
	(client_state_t, omp_xml_handle_start_element,
	omp_xml_handle_end_element): Add GET_DEPENDENCIES and GET_RULES handling.
	(current_server_plugin_dependency_dependencies,
	make_server_plugins_dependencies, add_server_plugins_dependency,
	make_current_server_plugin_dependency,
	maybe_free_current_server_plugin_dependency,
	finish_current_server_plugin_dependency): Use a list for the requirements
	instead of an array.
	(server_t, maybe_free_server_rules, make_server_rules,
	add_server_rule): Track rules size.
	(print_preference): Rename to send_preference.
	(process_omp_server_input): In OTP rule parsing, check for end marker
	before searching for semicolon.

2009-02-06  Michael Wuegand <michael.wiegand@intevation.de>

	* doc/CMakeLists.txt: Fixed syntax error which caused the build process
	to fail.

2009-02-05  Matthew Mundell <matt@mundell.ukfsn.org>

	* doc/CMakeLists.txt: Only install manpage if xmltoman is installed.

2009-02-05  Matthew Mundell <matt@mundell.ukfsn.org>

	Add OMP GET_PREFERENCES.  Retry reading from server on error.

	* src/openvasmd.c (BUFFER_SIZE): Increase.
	(grow_description): Fix trace message.
	(client_state_t, omp_xml_handle_start_element,
	omp_xml_handle_end_element): Add GET_PREFERENCES handling.
	(print_preference): New function.
	(read_from_server): Retry the recv on error, up to 5 times.

2009-02-04  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/omp_delete_task_0.c: New file.
	* src/tests/omp_delete_task_0: Remove.

2009-02-04  Matthew Mundell <matt@mundell.ukfsn.org>

	Add test of DELETE_TASK.

	* src/tests/CMakeLists.txt: Add omp_delete_task_0.

	* src/tests/omp_delete_task_0.c: New file.

2009-02-04  Matthew Mundell <matt@mundell.ukfsn.org>

	Add a few entity access functions.

	* src/tests/common.c (entity_text, entity_name, compare_entity_with_name,
	entity_child): New functions.

	* src/tests/common.h: Declare new functions.

2009-02-04  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (free_task, delete_task): New functions.
	(free_tasks): Move single task freeing to free_task.
	(make_task): Add a comment.
	(omp_xml_handle_start_element, omp_xml_handle_end_element,
	omp_xml_handle_text): Add DELETE_TASK handling.

	* ChangeLog: Correct function name on 2009-02-03 entry.

2009-02-03  Matthew Mundell <matt@mundell.ukfsn.org>

	Add test of ABORT_TASK.

	* src/tests/CMakeLists.txt: Add omp_abort_task_0.

	* src/tests/omp_abort_task_0.c: New file.

2009-02-03  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/omp_start_task_0.c: Correct comment.

2009-02-03  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (stop_task): New function.
	(omp_xml_handle_start_element, omp_xml_handle_end_element,
	omp_xml_handle_text): Add ABORT_TASK handling.

2009-02-02  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/common.h (close_manager_connection): New function.

	* src/tests/common.c (close_manager_connection): New function.
	(send_to_manager): Add a trace message.
	(print_entity): Flush stream afterwards.

	* src/tests/omp_modify_task_0.c, src/tests/omp_new_task_0.c,
	src/tests/omp_start_task_0.c, src/tests/omp_version_0.c:
	Use close_manager_connection.

	* src/tests/omp_status_0.c: Add expected problem counts.
	Use close_manager_connection.

2009-02-02  Matthew Mundell <matt@mundell.ukfsn.org>

	Add OTP problem report handling (DEBUG, HOLE, INFO, NOTE).  Fix
	errors in append_task_open_port and omp_xml_handle_end_element.
	Update the OMP read loop to only try fill the read buffers once per
	select.

	* src/openvasmd.c (server_state_t): Add problem report states.
	(task_t): Add problem report members.
	(free_tasks): Free problem report arrays.
	(make_task): Initialise problem report arrays.
	(start_task): Add required client preferences.
	(add_task_description_line): Correct comment.
	(append_task_open_port): Increment open_ports_size instead of open_ports.
	(report_t): New type.
	(current_report): New variable.
	(make_report, set_report_description, append_debug_report,
	append_hole_report, append_info_report, append_log_report,
	append_note_report): New functions.
	(omp_xml_handle_end_element): Free modify_task_value instead of
	freeing modify_task_parameter twice.  Add problem report counts to status
	response.
	(process_omp_server_input): Add problem report handling.
	(serve_omp): Only try fill the read buffers once per select instead of
	reading and handling as much as possible before selecting again (as
	introduced on 2008-12-10).  This is to ensure that the client or server
	is read when the other party is writing alot.

2009-01-26  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: (omp_xml_handle_end_element): Flush whitespace from
	task response XML.

2009-01-26  Matthew Mundell <matt@mundell.ukfsn.org>

	Improve entity reading and comparison.

	* src/tests/common.h: (add_entity, free_entity, print_entity,
	print_entities, compare_entities): New functions.
	(entities_t, entity_t): New types.

	* src/tests/common.c: (add_entity, compare_entities, foreach_print_entity,
	free_entity, make_entity, print_entity, print_entities): New functions.
	(context_data_t): New type.
	(handle_start_element, handle_end_element handle_text, read_entity): Read
	the entire element.

	* src/tests/omp_modify_task_0.c, src/tests/omp_new_task_0.c,
	src/tests/omp_start_task_0.c, src/tests/omp_status_0.c,
	src/tests/omp_version_0.c: Use new entity reading and comparison.

2009-01-26  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/common.c: Match comments to style guide.

2009-01-20  Matthew Mundell <matt@mundell.ukfsn.org>

	Do server connection and initialisation lazily, when the first command
	is written to the server.  Start OMP STATUS TASK_ID handling.  Add OTP
	BYE handling.  Ensure that grow_description allocates enough memory.

	* src/ovas-mngr-comm.c: (connect_to_server): New function.

	* src/ovas-mngr-comm.h: Match style guide.
	(connect_to_server): New function.

	* src/openvasmd.c: (server_initialising): Remove.
	(client_state_t): Add CLIENT_STATUS_TASK_ID.
	(server_state_t): Add SERVER_BYE.
	(server_init_state_t): New type.
	(server_init_state, server_init_offset): New variables.
	(set_server_init_state, write_string_to_server): New functions.
	(start_task): Neaten formatting.
	(append_to_task_identifier): Correct doc return.
	(grow_description): Add minimum increment argument.
	(add_task_description_line): Pass grow_description minimum increment.
	(omp_xml_handle_start_element, omp_xml_handle_end_element,
	omp_xml_handle_text): Use NULL instead of 0.  Start XML STATUS TASK_ID
	handling.
	(omp_xml_handle_error): Describe error in message.
	(process_omp_server_input): Moving writing of server initialisation
	messages to write_to_server.  Add OTP BYE handling.
	(write_to_server): Add server connecting and sending of initialisation
	messages (moved here from process_omp_server_input and serve_client).
	(process_omp): Account for new initialisation mechanism.
	(serve_client): Move server connecting to write_to_server (via new
	function connect_to_server).

2009-01-18  Matthew Mundell <matt@mundell.ukfsn.org>

	* doc/Doxyfile (INPUT): Add string.c and tracef.h.

	* doc/CMakeLists.txt: Add string.c and tracef.h to .built-html rule dependencies.
	Drop dependencies from doc rule that are covered by .built-html.

2009-01-18  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/ovas-mngr-comm.c: Add TRACE define.  Move @file comment to beginning.

2009-01-18  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/string.h: Add header comment.

	* src/string.c: Add header and @file comments.  Match comment docs to style guide.

	* src/tracef.h: Add header and @file comments.  Match comment docs to style guide.

2009-01-18  Matthew Mundell <matt@mundell.ukfsn.org>

	Add simple test of XML OMP STATUS.

	* src/tests/omp_status_0.c: New file.

	* src/tests/CMakeLists.txt: Add new test.

	* ChangeLog: Correct file name on previous entry.

2009-01-18  Matthew Mundell <matt@mundell.ukfsn.org>

	Add initial XML OMP STATUS and improve server initialisation.

	* src/openvasmd.c: (client_state_t): Add CLIENT_STATUS.
	(start_task): Add space before parenthesis.
	(process_omp_old_client_input): Fixup formatting.
	(omp_xml_handle_start_element, omp_xml_handle_end_element,
	omp_xml_handle_text): Add STATUS handling.  Let default case handle all
	0 assertions.
	(process_omp_server_input): In server init case check for enough input
	and process all available input.
	(read_from_client, read_from_server): Improve formatting and trace message.
	(serve_omp): Only read from client after server has initialised.

	* ChangeLog: Correct file name on previous entry.

2009-01-17  Matthew Mundell <matt@mundell.ukfsn.org>

	* doc/Doxyfile: Turn off JAVADOC_AUTOBRIEF.

2009-01-17  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Match comments to coding style.

	* src/ovas-mngr-comm.c: Match comments to coding style.

2009-01-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (server_context, xml_context, port_protocol_t,
	port_t): Add comments docs.
	(append_to_task_comment, append_to_task_identifier): Correct doc for
	length param.

2009-01-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* doc/Doxyfile (INPUT): Add ovas-mngr-comm.c.

	* doc/CMakeLists.txt: Add ovas-mngr-comm.c to doc depends.

2009-01-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/ovas-mngr-comm.c: Fix a few file doc typos.

2009-01-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/ovas-mngr-comm.c (send_to_server): Add space after function name.

2009-01-16  Matthew Mundell <matt@mundell.ukfsn.org>

	Add simple test of XML OMP START_TASK.

	* src/tests/omp_start_task_0.c: New file.

	* src/tests/CMakeLists.txt: Add new test.

2009-01-16  Matthew Mundell <matt@mundell.ukfsn.org>

	Add initial XML OMP START_TASK.

	* src/openvasmd.c: (client_state_t): Add START_TASK states.
	(modify_task_task_id): Rename current_task_task_id.
	(omp_xml_handle_start_element, omp_xml_handle_end_element,
	omp_xml_handle_text): Add START_TASK handling.

2009-01-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Convert tabs to spaces.

	* ChangeLog: Correct previous entry.

2009-01-16  Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>

	Started to move communication with server to a module
	of its own.

	* src/ovas-mngr-comm.c: New. Contains functionality
	for communication with openvas-server factored out
	from openvasmd.c.

	* src/ovas-mngr-comm.h: New. Protos for respective API.

	* src/openvasmd.c (send_to_server, to_server, to_server_end):
	Removed. This is now
	part of the new module ovas-mngr-comm.

	* src/CMakeLists.txt: Added handling for module ovas-mngr-comm.

2009-01-15  Matthew Mundell <matt@mundell.ukfsn.org>

	Add simple tests of XML OMP OMP_VERSION, NEW_TASK and MODIFY_TASK.

	* src/tests/common.c, src/tests/common.h, src/tests/omp_modify_task_0.c,
	src/tests/omp_new_task_0.c,	src/tests/omp_version_0.c: New files.

	* src/tests/CMakeLists.txt: Add config library and new tests.

2009-01-15  Matthew Mundell <matt@mundell.ukfsn.org>

	Add initial XML OMP NEW_TASK and MODIFY_TASK.  Document functions.

	* src/openvasmd.c (client_state_t): New type.
	(client_state, modify_task_parameter, modify_task_task_id,
	modify_task_variable): New variables.
	(append_to_task_comment, append_to_task_identifier, set_client_state,
	set_task_parameter): New functions.
	(add_task_description_line): Add const qualifer to parameter.
	(omp_xml_handle_start_element, omp_xml_handle_end_element,
	omp_xml_handle_text): Add comment docs.  Add NEW_TASK and
	MODIFY_TASK.
	(omp_xml_handle_error): Add comment doc.

2009-01-15  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/tests/strip_space_0.c, src/tests/strip_space_1.c,
	src/tests/strip_space_2.c, src/tests/strip_space_2.c: Add file header
	comments.

2009-01-15  Matthew Mundell <matt@mundell.ukfsn.org>

	* INSTALL: Correct Cmake command.

2009-01-15  Matthew Mundell <matt@mundell.ukfsn.org>

	Start XML OMP handling.

	* src/openvasmd.c (xml_context): New variable.
	(process_omp_old_client_input): New function with old
	process_omp_client_input code.
	(process_omp_client_input): Start XML parsing.
	(XML_RESPOND, omp_xml_handle_start_element,
	omp_xml_handle_end_element, omp_xml_handle_text,
	omp_xml_handle_error): New functions.
	(serve_omp): Add XML parser and context initialisation.

2009-01-09  Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>

	Turned TO_SERVER into a method and changed all calls.

	* src/openvasmd.c (TO_SERVER): Transformed this macro into
	method send_to_server.
	(send_to_server): New. Functionlity of TO_SERVER, but returns 1
	for error instead of goto statement.
	(start_task, process_omp_server_input): Changed calls from
	TO_SERVER macro to send_to_server method and did according cleanups.

2008-12-23  Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>

	* src/Makefile: Removed. It is overwritten by cmake anyway.

2008-12-23  Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>

	* INSTALL: Added information about the prefix setting for cmake.

2008-12-22  Matthew Mundell <matt@mundell.ukfsn.org>

	* CMakeLists.txt: Enable testing.

	* src/CMakeLists.txt: Add string library and a tests subdirectory.

	* src/string.h, src/string.c, src/tracef.h, tests/, tests/CMakeLists.txt,
	tests/strip_space_0.c, tests/strip_space_1.c, tests/strip_space_2.c,
	tests/strip_space_3.c: New.

	* src/openvasmd.c (tracef): Move to tracef.h.
	(strip_space): Rework.  Move to string.c.
	(process_omp_server_input): Correct from_start and input updating in
	<|> field loop.  Correct and update call to strip_space.

2008-12-19  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (process_omp_server_input): Improve open port number
	parsing.

2008-12-19  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (serve_otp): Use a flag instead of a goto when
	writing to the fd.

2008-12-19  Matthew Mundell <matt@mundell.ukfsn.org>

	Add server PORT command handling.

	* src/openvasmd.c (append_task_open_port): New function.
	(free_tasks): Free open_ports.
	(make_task, start_task): Init open_ports.
	(port_protocol_t, port_t): New types.
	(process_omp_server_input): Add PORT handling.

2008-12-19  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Convert tabs to spaces.

2008-12-17  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (write_to_client, write_to_server): New functions.
	(serve_omp): Describe and simplify the select loop.  Move writing code
	out to new functions write_to_client and write_to_server.

2008-12-17  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Drop the OVAS_SSL directive in favour of always
	compiling secure transmission.

2008-12-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: (strip_space): Correct terminating check.
	(make_task, serve_client): Replace goto loops with structured loops.
	(process_omp_client_input, process_omp_server_input): Format signatures
	like rest of file.
	(process_omp_server_input): Finish TIME HOST_END handling.  Move the
	out of memory destination to be a fail case.

2008-12-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: (set_server_state): New function.
	(process_omp_server_input): Always set the server state via
	set_server_state, to reduce the amount of tracing code.

2008-12-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Replace \return with @return in comment docs.

2008-12-16  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (current_server_task): New variable.
	(set_task_ports): New function.
	(process_omp_client_input): Turn off messages tracing.  Separate some
	of the response codes.  Use a local variable for the task in the
	START_TASK case.
	(process_omp_server_input): Turn off messages tracing.  Add TIME and
	STATUS message handling.

2008-12-12  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (read_from_client, read_from_server
	read_protocol): Improve function docs.

2008-12-11  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Bring code documentation up to date.

2008-12-11  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c (process_omp_client_input): Replace use of asprintf
	with g_strdup_printf.

2008-12-11  Matthew Mundell <matt@mundell.ukfsn.org>

	* CMakeLists.txt: Prefix paths in variables with CMAKE_INSTALL_PREFIX.

	* src/CMakeLists.txt: Drop hard coded include paths.

2008-12-10  Matthew Mundell <matt@mundell.ukfsn.org>

	* openvasmd.c: Convert tabs to spaces.

2008-12-10  Matthew Mundell <matt@mundell.ukfsn.org>

	* openvasmd.c (OPENVASMD_ADDRESS): Remove.
	(main): Bind to INADDR_ANY by default.

2008-12-10  Matthew Mundell <matt@mundell.ukfsn.org>

	* openvasmd.c (serve_otp, read_protocol, serve_client):
	Drop EAGAIN and EINTR checks from OVAL_SSL cases.

2008-12-10  Matthew Mundell <matt@mundell.ukfsn.org>

	After selecting, ensure that all input is read before the fd is
	selected again.  Start handling server input: preferences, plugins
	dependencies and rules.  Improve server input field parsing.

	* openvasmd.c: Prefix tracing messages with 3 spaces.  Improve a few
	comments.
	(strip_space): Only strip spaces.
	(TO_SERVER, start_task): Update fail destination.
	(serve_otp, read_protocol): Compare GNUTLS_E_REHANDSHAKE to count
	instead of errno.
	(RESPOND): Update to revert parsing on fail.  Update fail destination.
	(process_omp_client_input): Update to revert parsing on start_task and
	RESPOND failure.  Update RESPOND fail destination.
	(process_omp_server_input): Only update from_server_start after
	TO_SERVER, in case TO_SERVER fails.  On successful exit, reset the
	from_server buffer.  In the SERVER_DONE handling only strip spaces,
	exit if there are too few characters in the message and move messages
	along on success.  Add preference, rule and plugins dependencies
	handling.  Improve the check for <|>.
	(serve_omp): Compare count to GNUTLS_E_REHANDSHAKE instead of errno.
	Move reading out to new functions read_from_client and
	read_from_server.  After selecting, ensure that all input is read
	before the fd is selected again, including the cases where processing
	of the input must wait for space in one of the output buffers
	to_server and to_client.  Drop the EAGAIN and EINTR check from
	the OVAL_SSL cases.
	(current_server_preference, current_server_plugin_dependency_name,
	current_server_plugin_dependency_dependencies): New variables.
	(free_g_ptr_array, maybe_free_server_preferences,
	make_server_preferences, add_server_preference,
	maybe_free_server_plugins_dependencies,
	make_server_plugins_dependencies, add_server_plugins_dependency,
	make_current_server_plugin_dependency,
	append_to_current_server_plugin_dependency,
	maybe_free_current_server_plugin_dependency,
	finish_current_server_plugin_dependency, free_rule,
	maybe_free_server_rules, make_server_rules, add_server_rule,
	read_from_client, read_from_server): New functions.

2008-12-03  Matthew Mundell <matt@mundell.ukfsn.org>

	Add more OMP commands, start adding server communication.

	* openvasmd.c: Add server records.  Add some task allocation tracing.
	(free_tasks, make_task): Correct looping.
	(current_task): Rename current_client_task;
	(tracef, logf): Flush trailing semicolons.
	(CLIENT_READ, CLIENT_WRITE): Rename FD_CLIENT_*.
	(SERVER_READ, SERVER_WRITE): Rename FD_SERVER_*.
	(find_task, modify_task, start_task, strip_space): New functions.
	(process_omp_input): Rename to process_omp_client_input.
	(process_omp_client_input): Rename from process_omp_input. Add
	beginnings of MODIFY_TASK, START_TASK and STATUS.
	(process_omp_server_input): New function.
	(TO_SERVER): New macro.
	(serve_omp): Add server init and process_omp_server_input call.
	Improve formatting.
	(accept_and_maybe_fork): Add client socket shutdowns.  Move client socket
	close out of OVAS_SSL case.

2008-11-27  Matthew Mundell <matt@mundell.ukfsn.org>

	Add OMP commands OTP_VERSION, LOGIN and NEW_TASK.

	* openvasmd.c (task_t, grow_tasks, free_tasks, make_task): New.
	(grow_description, add_task_description_line): New.
	(RESPOND, process_omp_input): New.
	(serve_omp): Handle OTP_VERSION, LOGIN and NEW_TASK.
	Convert tabs to spaces.

2008-11-26  Matthew Mundell <matt@mundell.ukfsn.org>

	Add choosing of protocol based on first message.

	* openvasmd.c (OMP, serve_otp, serve_client): New.
	(read_protocol, serve_client): New.
	(accept_and_maybe_fork): Call serve_client instead
	of serve_omp.
	(serve_omp): Move OTP code to serve_otp.

2008-11-21  Matthew Mundell <matt@mundell.ukfsn.org>

	* README: Update for new build system.

2008-11-21  Matthew Mundell <matt@mundell.ukfsn.org>

	* doc/CMakeLists.txt: Ensure html/ exists.

	* doc/Doxyfile: Correct paths.

	* doc/openvasmd.8.xml: Add header comment.

2008-11-21  Matthew Mundell <matt@mundell.ukfsn.org>

	Add cmake build support and a manpage.

	* Makefile: Removed.

	* footer.html, Doxyfile: Removed (moved to doc/).

	* CMakeLists.txt, doc/, doc/CMakeLists.txt, INSTALL,
	src/CMakeLists.txt,	doc/openvasmd.8.xml: New.

	* doc/footer.html, doc/Doxyfile: New (moved from ..).

2008-11-21  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Flesh out \mainpage.  Add parameters to function
	docs.  Clean up docs a little.
	(OVM_OS_NAME): rename OPENVAS_OS_NAME.

2008-11-20  Michael Wiegand <michael.wiegand@intevation.de>

	* README: Fixed typo.

2008-11-17  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmc.c: Add Doxygen documentation.

	* Doxyfile, footer.html: New.

2008-11-17  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Drop the *_PORT_OVERRIDE directives.  Turn off
	tracing.
	(main): Add option processing.
	(handle_signal): Add SIGINT handling.

	* src/Makefile: Add flags for glib.

2008-11-17  Matthew Mundell <matt@mundell.ukfsn.org>

	* src/openvasmd.c: Rename directives for consistency.

2008-11-11  Jan-Oliver Wagner <jan-oliver.wagner@intevation.de>

	Starting module "openvas-manager".

	* COPYING, ChangeLog, README, src/Makefile, src/openvasmd.c: New.
